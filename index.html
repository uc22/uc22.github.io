<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>点到线的距离和最近点</title>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" type="text/css">
    <script src="https://lib.sinaapp.com/js/jquery/2.0.2/jquery-2.0.2.min.js" type="text/javascript"></script>
    <script src="transGps.js" type="text/javascript"></script>
    <style>
        html,
        body,
        #container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="container" style="width:80%;display:block;float: left">
    </div>
    
    <div id="mumebox" style="width:20%; height: 100%;background-color:#0fbcf9;float: right;display:block">
        <div style="width:100%; height: 30%;background-color:#fff;display:block">
            <span style="margin-bottom:0px">导入线路</span><span id="busuanzi_container_site_pv" style="float:right">共计使用<span id="busuanzi_value_site_pv"></span>次</span>
            <textarea id="inline" style="width:100%; height: 100%;resize: none;max-height:calc(100% - 20px);font-size:10px;" placeholder="一行一对经纬度，英文逗号或Tab分隔,可直接从Excel中复制粘贴&#10经度,纬度&#10经度    纬度"></textarea>
        </div>
        <div style="width:100%; height: 30%;background-color:#fff;display:block">
            <p>导入点</p>
            <textarea id="inpoint" style="width:100%; height:100%;resize: none;max-height: calc(100% - 40px);font-size:10px;" placeholder="一行一对经纬度，英文逗号或Tab分隔,可直接从Excel中复制粘贴，描述可选&#10经度,纬度[,描述]&#10经度  纬度[  描述]"></textarea>
            <input type="checkbox" name="showline" checked>显示线路
            <input type="checkbox" name="showpoint" checked>显示点
            <input class="btn" id="submit" value="提交" type="button">
        </div>

        <div style="width:100%; height: 33%;background-color:#fff;display:block">
            <p>计算结果</p>
            <textarea id="result" style="width:100%; height:100%;resize: none;max-height: calc(100% - 20px);font-size:10px;" placeholder="结果和导入点的顺序一致，结果格式:&#10点描述,交点经度,交点纬度,距离"></textarea>
        </div>
        <div style="width:100%; height: 6.9%;background-color:#fff;display:block">
            鼠标左键经纬度:<input type="text" id="lnglat">
        </div>
    </div>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=608d75903d29ad471362f8c550daf:112:485"></script>
    <script type="text/javascript">
        //初始化地图对象，加载地图
        var map = new AMap.Map("container", {
            resizeEnable: true,
            zoom: 13
        });
        var path = [];//路径
        var path1 = [];//点
        var pinfo = [];//点描述



        $("#inline").on('input', function (e) {
            if ($(this).val().trim() != "") {
                path = text2path($(this).val().trim().replace(" ", ""));
                var polyline = new AMap.Polyline({
                    map: map,
                    path: path,
                    strokeColor: '#EA2027',
                });
                map.setCenter([(path[0].getLng() + path[path.length - 1].getLng()) / 2, (path[0].getLat() + path[path.length - 1].getLat()) / 2]);
            }
        });
        $("#inpoint").on('input', function (e) {
            if ($(this).val().trim() != "") {
                path1 = text2path($(this).val().trim().replace(" ", ""));
                for (i = 0; i < path1.length; i++) {
                    var marker = new AMap.Marker({
                        map: map,
                        draggable: false,
                        label: { content: path1[i][2], offset: new AMap.Pixel(0, 0), direction: 'top' },
                        position: [path1[i][0], path1[i][1]]
                    });
                };

                //map.setCenter([(parseFloat(line[0].split(",")[0]) + parseFloat(line[line.length - 1].split(",")[0])) / 2, (parseFloat(line[0].split(",")[1]) + parseFloat(line[line.length - 1].split(",")[1]))/2]);
            }
        });
        $("#submit").click(function () {
            if (path == "" && $("#inline").val().trim() != "") {
                path = text2path($("#inline").val().trim().replace(" ", ""));
                if ($("input[name='showline']").prop("checked")) {
                    var polyline = new AMap.Polyline({
                        map: map,
                        path: path,
                        strokeColor: '#EA2027'
                    });
                    map.setCenter([(path[0].getLng() + path[path.length - 1].getLng()) / 2, (path[0].getLat() + path[path.length - 1].getLat()) / 2]);
                };

            };
            if (path1 == "" && $("#inline").val().trim() != "") {
                path1 = text2path($("#inpoint").val().trim().replace(" ", ""));
                if ($("input[name='showpoint']").prop("checked")) {
                    for (var i = 0; i < path1.length; i++) {
                        var marker = new AMap.Marker({
                            map: map,
                            draggable: false,
                            label: { content: path1[i][2], offset: new AMap.Pixel(0, 0), direction: 'top' },
                            position: [path1[i][0], path1[i][1]]
                        });
                    };
                }

            };

            if (path != "" && path1 != "") {
                var d, p, p1;
                var result = "";
                $("#result").val(result);
                for (var i = 0; i < path1.length; i++) {
                    p = AMap.GeometryUtil.closestOnLine(path1[i], path);
                    p1 = gcj02towgs84(p[0], p[1])
                    d = Math.round(AMap.GeometryUtil.distanceToLine(path1[i], path));
                    result += path1[i][2] + ','+ p1 + ',' + d + '\n';
                };
                $("#result").val(result);
            }
            else {
                alert("线路或者点不能为空！");
            }
        });
        function text2path(text) {
            var line = text.split('\n');
            var separator;
            if (line[0].indexOf(",") != -1) {
                separator = ",";
            } else if (line[0].indexOf("\t") != -1) {
                separator = "\t";
            } else {
                alert("格式错误！");
                return;
            };
            var path = [];
            if (line[0].split(separator).length == 2) {
                for (var i = 0; i < line.length; i++) {
                    var l = line[i].split(separator)
                    var p = wgs84togcj02(parseFloat(l[0]), parseFloat(l[1]));
                    path.push(p);
                };
            }
            else {
                for (var i = 0; i < line.length; i++) {
                    var l = line[i].split(separator)
                    var p = wgs84togcj02(parseFloat(l[0]), parseFloat(l[1]));
                    path.push([p[0], p[1], l[2]]);
                };
            };

            return path;
        };
        map.on('click', function (e) {
            document.getElementById("lnglat").value = gcj02towgs84(e.lnglat.getLng(),e.lnglat.getLat())
        });
    </script>
</body>
</html>
